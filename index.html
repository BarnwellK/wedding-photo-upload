<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ken & Dee's Wedding Gallery</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

  <!-- Toastify for notifications -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <!-- GLightbox -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
  <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: url('https://images.unsplash.com/photo-1636632519127-c6e09af4a3b5?q=80&w=2070&auto=format&fit=crop') no-repeat center center fixed;
      background-size: cover;
      background-attachment: fixed;
      background-color: #fff8f0;
      min-height: 100vh;
    }
    .overlay {
      background: rgba(255, 248, 240, 0.90);
      backdrop-filter: blur(2px);
      min-height: 100vh;
      padding: 20px;
    }
    header {
      text-align: center;
      padding: 40px 20px 20px;
      font-family: 'Georgia', serif;
      color: #bfa060;
    }
    header h1 {
      margin: 0;
      font-size: 2.8em;
      letter-spacing: 2px;
    }
    header p {
      margin-top: 10px;
      font-size: 1.2em;
      color: #a88b5b;
    }
    .upload-btn, .download-btn {
      position: fixed;
      bottom: 30px;
      background-color: #bfa060;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      font-size: 32px;
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: background 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .upload-btn:hover, .download-btn:hover {
      background-color: #a88b5b;
    }
    .upload-btn { right: 30px; }
    .download-btn { left: 30px; }
    .selection-box {
      position: fixed;
      bottom: 110px;
      left: 30px;
      background: #fff5dd;
      padding: 10px 16px;
      border-radius: 12px;
      display: none;
      font-size: 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .selected img {
      outline: 4px solid #a88b5b;
      outline-offset: -4px;
    }
    #fileInput { display: none; }
    #previewContainer {
      margin-top: 40px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    .preview-wrapper img {
      width: 180px;
      border-radius: 12px;
      object-fit: cover;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s;
    }
    .preview-wrapper img:hover { transform: scale(1.05); }
  </style>
</head>
<body>
<div class="overlay">
  <header>
    <h1>Ken & Dee's Wedding Gallery</h1>
    <p>Thank you for sharing our beautiful day ðŸ’›</p>
  </header>
  <div id="previewContainer"></div>
  <div class="selection-box" id="confirmDownload">
    <span id="selectionCount">0 selected</span>
    <button id="downloadSelected">Download</button>
  </div>
  <button class="upload-btn" id="uploadButton">+</button>
  <button class="download-btn" id="downloadButton">â¬‡</button>
  <input id="fileInput" type="file" multiple>
</div>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAAOqmYEYPjvoxSogDLHNqMS4CoSXfsrgs",
    authDomain: "ken-and-dee-wedding-photos.firebaseapp.com",
    projectId: "ken-and-dee-wedding-photos",
    storageBucket: "ken-and-dee-wedding-photos.firebasestorage.com",
    messagingSenderId: "1071327540442",
    appId: "1:1071327540442:web:2f611f8804bd1bd95761e3"
  };
  firebase.initializeApp(firebaseConfig);
  const storage = firebase.storage();

  const fileInput = document.getElementById('fileInput');
  const uploadButton = document.getElementById('uploadButton');
  const downloadButton = document.getElementById('downloadButton');
  const previewContainer = document.getElementById('previewContainer');
  const confirmDownload = document.getElementById('confirmDownload');
  const selectionCount = document.getElementById('selectionCount');
  const downloadSelected = document.getElementById('downloadSelected');

  let downloadMode = false;
  const selectedUrls = new Set();

  const lightbox = GLightbox({ selector: '.glightbox' });

  uploadButton.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > 50 * 1024 * 1024) {
      alert("File is too large! Must be under 50 MB.");
      return;
    }
    uploadFile(file);
  });

  downloadButton.addEventListener('click', () => {
    downloadMode = true;
    confirmDownload.style.display = 'block';
  });

  downloadSelected.addEventListener('click', () => {
    selectedUrls.forEach(({ url, filename }) => {
      const a = document.createElement('a');
      a.href = url;
      a.download = filename || 'photo.jpg';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    });
    downloadMode = false;
    confirmDownload.style.display = 'none';
    selectedUrls.clear();
    document.querySelectorAll('.preview-wrapper').forEach(el => el.classList.remove('selected'));
  });

  async function uploadFile(file) {
    const fileName = Date.now() + '-' + file.name;
    const storageRef = storage.ref('wedding-photos/' + fileName);
    const uploadTask = storageRef.put(file);

    uploadTask.on('state_changed', null, error => {
      Toastify({ text: "Upload failed", backgroundColor: "red", duration: 3000 }).showToast();
    }, () => {
      uploadTask.snapshot.ref.getDownloadURL().then(downloadURL => {
        addPhoto(downloadURL, file.name);
        Toastify({ text: "Upload successful!", backgroundColor: "green", duration: 3000 }).showToast();
      });
    });
  }

  function addPhoto(url, filename = null) {
    const wrapper = document.createElement('div');
    wrapper.className = 'preview-wrapper';
    wrapper.dataset.filename = filename || 'photo.jpg';

    const anchor = document.createElement('a');
    anchor.href = url;
    anchor.className = 'glightbox';
    anchor.dataset.gallery = 'gallery1';

    const image = document.createElement('img');
    image.src = url;
    image.loading = 'lazy';

    anchor.appendChild(image);
    wrapper.appendChild(anchor);
    previewContainer.prepend(wrapper);

    wrapper.addEventListener('click', e => {
      if (!downloadMode) return;
      e.preventDefault();
      wrapper.classList.toggle('selected');
      const item = { url, filename: wrapper.dataset.filename };
      if (wrapper.classList.contains('selected')) {
        selectedUrls.add(item);
      } else {
        selectedUrls.forEach(entry => {
          if (entry.url === url) selectedUrls.delete(entry);
        });
      }
      selectionCount.textContent = `${selectedUrls.size} selected`;
    });

    lightbox.reload();
  }

  async function loadPhotos() {
    const ref = storage.ref('wedding-photos/');
    const list = await ref.listAll();
    const urls = await Promise.all(list.items.map(async item => {
      const url = await item.getDownloadURL();
      return { url, name: item.name.split('-').slice(1).join('-') || 'photo.jpg' };
    }));
    urls.reverse();
    urls.forEach(({ url, name }) => addPhoto(url, name));
  }

  loadPhotos();
</script>
</body>
</html>
