<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Our Wedding Gallery</title>
  <style>
    body {
      margin: 0;
      font-family: 'Helvetica Neue', sans-serif;
      background: #fafafa;
      color: #333;
      text-align: center;
    }

    header {
      background: #6b4c3b;
      color: white;
      padding: 20px 0;
      font-size: 32px;
      font-weight: bold;
    }

    .upload-section {
      margin: 30px 0;
    }

    .upload-section input[type="file"] {
      padding: 10px;
      margin-top: 10px;
    }

    .upload-section button {
      padding: 10px 20px;
      margin-top: 15px;
      background-color: #6b4c3b;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }

    .upload-section button:hover {
      background-color: #5a3e31;
    }

    #status {
      margin-top: 10px;
    }

    #progress-container {
      width: 90%;
      max-width: 400px;
      height: 20px;
      background: #ddd;
      margin: 20px auto;
      border-radius: 10px;
      overflow: hidden;
      display: none;
    }

    #progress-bar {
      height: 100%;
      width: 0%;
      background: #6b4c3b;
      transition: width 0.3s;
    }

    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }

    .gallery img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: transform 0.2s;
    }

    .gallery img:hover {
      transform: scale(1.05);
    }

    /* Fullscreen Lightbox */
    .lightbox {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 1000;
    }

    .lightbox img {
      max-width: 90%;
      max-height: 80vh;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(255,255,255,0.2);
    }

    .lightbox button {
      padding: 10px 20px;
      font-size: 16px;
      background: #6b4c3b;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }

    .lightbox button:hover {
      background: #5a3e31;
    }

    .close-lightbox {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 40px;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>

<header>
  Our Wedding Gallery
</header>

<div class="upload-section">
  <input type="file" id="file-upload" accept="image/*" />
  <br>
  <button id="upload-button">Upload Photo</button>
  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>
  <p id="status"></p>
</div>

<div class="gallery" id="gallery"></div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox">
  <span class="close-lightbox" id="close-lightbox">&times;</span>
  <img id="lightbox-img" src="" alt="Full View">
  <a id="download-btn" download>
    <button>Download Photo</button>
  </a>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  // Your Firebase config here
  const firebaseConfig = {
  apiKey: "AIzaSyAAOqmYEYPjvoxSogDLHNqMS4CoSXfsrgs",
  authDomain: "ken-and-dee-wedding-photos.firebaseapp.com",
  projectId: "ken-and-dee-wedding-photos",
  storageBucket: "ken-and-dee-wedding-photos.firebasestorage.app",
  messagingSenderId: "1071327540442",
  appId: "1:1071327540442:web:2f611f8804bd1bd95761e3"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const storage = firebase.storage();
  const storageRef = storage.ref('wedding-photos');

  const statusText = document.getElementById('status');
  const progressContainer = document.getElementById('progress-container');
  const progressBar = document.getElementById('progress-bar');
  const galleryDiv = document.getElementById('gallery');
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-img');
  const closeLightbox = document.getElementById('close-lightbox');
  const downloadBtn = document.getElementById('download-btn');

  document.getElementById('upload-button').addEventListener('click', async () => {
    const fileInput = document.getElementById('file-upload');
    const file = fileInput.files[0];
    if (!file) {
      alert('Please select a file.');
      return;
    }

    const photoRef = storageRef.child(file.name);

    try {
      await photoRef.getMetadata();
      statusText.innerHTML = '<span style="color:red;">Photo already exists!</span>';
    } catch (error) {
      if (error.code === 'storage/object-not-found') {
        const uploadTask = photoRef.put(file);

        progressContainer.style.display = 'block';
        progressBar.style.width = '0%';

        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            statusText.innerHTML = `Uploading... ${progress.toFixed(0)}%`;
            progressBar.style.width = `${progress}%`;
          },
          (error) => {
            console.error('Upload error:', error);
            statusText.innerHTML = '<span style="color:red;">Upload failed. Please try again.</span>';
            progressContainer.style.display = 'none';
          },
          () => {
            statusText.innerHTML = '<span style="color:green;">Uploaded successfully!</span>';
            progressContainer.style.display = 'none';
            loadGallery();
          }
        );
      } else {
        console.error('Metadata check error:', error);
        statusText.innerHTML = '<span style="color:red;">Error checking file.</span>';
      }
    }
  });


  // lazy load gallery
  async function loadGallery() {
  galleryDiv.innerHTML = '';

  try {
    const listResult = await storageRef.listAll();
    const itemsWithTime = [];

    for (const itemRef of listResult.items) {
      const url = await itemRef.getDownloadURL();
      const metadata = await itemRef.getMetadata();
      itemsWithTime.push({
        url: url,
        timeCreated: metadata.timeCreated
      });
    }

    // Sort by timeCreated DESCENDING (newest first)
    itemsWithTime.sort((a, b) => new Date(b.timeCreated) - new Date(a.timeCreated));

    // Now create the gallery
    for (const item of itemsWithTime) {
      const img = document.createElement('img');
      img.dataset.src = item.url;  // Use data-src for lazy loading
      img.alt = 'Wedding Photo';
      img.classList.add('lazy-load'); // Add a class for styling or identification
      img.addEventListener('click', () => {
        openLightbox(item.url);
      });

      galleryDiv.appendChild(img);

      // Lazy load image when it's in view
      lazyLoadImage(img);
    }
  } catch (err) {
    console.error('Error loading gallery:', err);
  }
}

// IntersectionObserver for lazy loading
function lazyLoadImage(img) {
  const observer = new IntersectionObserver((entries, observer) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const image = entry.target;
        image.src = image.dataset.src;  // Set the src from the data-src attribute
        observer.unobserve(image);  // Stop observing after image is loaded
      }
    });
  }, {
    rootMargin: '100px', // Load images a bit before they come into view
  });

  observer.observe(img);  // Observe the image element
}


  // Upload box
  function openLightbox(url) {
    lightbox.style.display = 'flex';
    lightboxImg.src = url;
    // Set download link to the image's URL
    downloadBtn.href = url;  
    downloadBtn.download = url.split('/').pop();  // Use the file name for the download

    // Show the lightbox with the download button
    downloadBtn.style.display = 'block';  // Ensure button is visible
  }

  closeLightbox.addEventListener('click', () => {
    lightbox.style.display = 'none';
    lightboxImg.src = '';
  });
  
  // Load gallery on startup
  window.onload = loadGallery;
</script>

</body>
</html>
