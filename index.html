<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Ken & Dee's Wedding Gallery</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

  <!-- Toastify -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <!-- GLightbox -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css">
  <script src="https://cdn.jsdelivr.net/npm/glightbox/dist/js/glightbox.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: url('https://images.unsplash.com/photo-1636632519127-c6e09af4a3b5?q=80&w=2070&auto=format&fit=crop') no-repeat center center fixed;
      background-size: cover;
      background-color: #fff8f0;
      min-height: 100vh;
    }

    .overlay {
      background: rgba(255, 248, 240, 0.9);
      backdrop-filter: blur(2px);
      min-height: 100vh;
      padding: 20px;
    }

    header {
      text-align: center;
      padding: 40px 20px 20px;
      font-family: 'Georgia', serif;
      color: #bfa060;
    }

    header h1 {
      margin: 0;
      font-size: 2.8em;
      letter-spacing: 2px;
    }

    header p {
      margin-top: 10px;
      font-size: 1.2em;
      color: #a88b5b;
    }

    .action-btn {
      position: fixed;
      bottom: 30px;
      width: 70px;
      height: 70px;
      border-radius: 50%;
      font-size: 30px;
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #uploadButton {
      right: 30px;
      background-color: #bfa060;
    }

    #downloadButton {
      right: 110px;
      background-color: #6d9cbe;
    }

    #uploadButton:hover {
      background-color: #a88b5b;
    }

    #downloadButton:hover {
      background-color: #5c89a9;
    }

    #fileInput {
      display: none;
    }

    #previewContainer {
      margin-top: 40px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }

    .preview-wrapper {
      position: relative;
      animation: fadeIn 1s ease forwards;
    }

    .preview-wrapper img {
      width: 180px;
      height: auto;
      border-radius: 12px;
      object-fit: cover;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s;
    }

    .preview-wrapper img:hover {
      transform: scale(1.05);
    }

    .preview-wrapper.selected img {
      border: 4px solid #6d9cbe;
      box-shadow: 0 0 15px rgba(109, 156, 190, 0.7);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

<div class="overlay">
  <header>
    <h1>Ken & Dee's Wedding Gallery</h1>
    <p>Thank you for sharing our beautiful day ðŸ’›</p>
  </header>

  <div id="previewContainer"></div>

  <button id="uploadButton" class="action-btn">+</button>
  <button id="downloadButton" class="action-btn">â†“</button>
  <input id="fileInput" type="file" multiple>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAAOqmYEYPjvoxSogDLHNqMS4CoSXfsrgs",
    authDomain: "ken-and-dee-wedding-photos.firebaseapp.com",
    projectId: "ken-and-dee-wedding-photos",
    storageBucket: "ken-and-dee-wedding-photos.firebasestorage.com",
    messagingSenderId: "1071327540442",
    appId: "1:1071327540442:web:2f611f8804bd1bd95761e3"
  };

  firebase.initializeApp(firebaseConfig);
  const storage = firebase.storage();

  const fileInput = document.getElementById('fileInput');
  const uploadButton = document.getElementById('uploadButton');
  const downloadButton = document.getElementById('downloadButton');
  const previewContainer = document.getElementById('previewContainer');

  let downloadMode = false;

  const lightbox = GLightbox({ loop: true });

  uploadButton.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file && file.size <= 50 * 1024 * 1024) {
      uploadFile(file);
    } else {
      alert("Please select a file smaller than 50 MB.");
    }
  });

  async function uploadFile(file) {
    const fileName = Date.now() + '-' + file.name;
    const storageRef = storage.ref('wedding-photos/' + fileName);
    const uploadTask = storageRef.put(file);

    uploadTask.on('state_changed',
      null,
      error => {
        console.error('Upload error:', error);
        Toastify({ text: "Upload failed", backgroundColor: "red" }).showToast();
      },
      async () => {
        const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
        addPhoto(downloadURL);
        Toastify({ text: "Upload successful!", backgroundColor: "green" }).showToast();
      }
    );
  }

  function addPhoto(url) {
    const wrapper = document.createElement('div');
    wrapper.className = 'preview-wrapper';
    wrapper.innerHTML = `
      <a href="${url}" class="glightbox" data-gallery="gallery1">
        <img src="${url}" loading="lazy">
      </a>
    `;

    wrapper.addEventListener("click", (e) => {
      if (downloadMode) {
        e.preventDefault();
        wrapper.classList.toggle("selected");
      }
    });

    previewContainer.prepend(wrapper);
    lightbox.reload();
  }

  async function loadPhotos() {
    const storageRef = storage.ref('wedding-photos/');
    const result = await storageRef.listAll();
    const items = result.items.reverse();

    for (const item of items) {
      const url = await item.getDownloadURL();
      addPhoto(url);
    }
  }

  async function downloadSelectedPhotos() {
    const selected = document.querySelectorAll(".preview-wrapper.selected");
    if (selected.length === 0) {
      alert("Select at least one photo to download.");
      return;
    }

    for (const wrapper of selected) {
      const img = wrapper.querySelector("img");
      const url = img.src;
      const storageRef = firebase.storage().refFromURL(url);

      try {
        const downloadURL = await storageRef.getDownloadURL();
        const metadata = await storageRef.getMetadata();
        const fileName = metadata.name;

        const a = document.createElement("a");
        a.href = downloadURL;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      } catch (err) {
        console.error("Failed to download:", err);
      }
    }

    exitDownloadMode();
  }

  function enterDownloadMode() {
    downloadMode = true;
    downloadButton.style.backgroundColor = "#d9534f";
  }

  function exitDownloadMode() {
    downloadMode = false;
    downloadButton.style.backgroundColor = "#6d9cbe";
    document.querySelectorAll(".preview-wrapper.selected").forEach(el => el.classList.remove("selected"));
  }

  downloadButton.addEventListener("click", () => {
    if (!downloadMode) {
      enterDownloadMode();
    } else {
      downloadSelectedPhotos();
    }
  });

  loadPhotos();
</script>

</body>
</html>
